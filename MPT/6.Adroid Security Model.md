Android Security Model = Multiple layers of protection

Defense in Depth approach:
├── Hardware Level
├── Kernel Level
├── OS Level
├── Application Level
└── User Level



 1. **USER LEVEL**   
     1. (Permissions, Consent) 

2. **APPLICATION LEVEL**
     1. (Sandbox, Signing, Permissions, Components)  

 3. **OS LEVEL** 
      1. (SELinux, Seccomp, ASLR, Encryption)

 4. **KERNEL LEVEL**        
       1. (Linux Kernel, Process Isolation)  

5. **HARDWARE LEVEL**    
     1. (TEE, Secure Boot, Hardware Keystore) 



## 1. Application Sandbox (Core Security)

Sandbox = Isolated environment for each app

Each app:
├── Gets unique Linux User ID (UID)
├── Runs in separate process
├── Has private data directory
├── Cannot access other apps' data

#### How UIDs Work

**SYSTEM USERS:**-

root       = UID 0
system     = UID 1000
radio      = UID 1001
bluetooth  = UID 1002


**APP USERS:-**

First app  = UID 10000 (u0_a0)
Second app = UID 10001 (u0_a1)
Third app  = UID 10002 (u0_a2)

Each app = Unique Linux user


#### Data Directory Permissions

**App private directory**
/data/data/com.example.app/
    │
    ├── Permissions: drwx------ (700)
    │   └── Only owner (app's UID) can access
    │
    ├── shared_prefs/
    ├── databases/
    ├── files/
    └── cache/

**Check permissions**
adb shell ls -la /data/data/

**Output**:
drwx------ u0_a100 u0_a100 com.app.one
drwx------ u0_a101 u0_a101 com.app.two
drwx------ u0_a102 u0_a102 com.app.three


#### Sandbox Exceptions

**WAYS TO SHARE DATA** 
1. SHARED USER ID (Same Developer)                         
    └── android:sharedUserId="com.example.shared"           
    └── Apps with same signature can share UID              
    └── Can access each other's data  


2. CONTENT PROVIDERS                                       
    └── Structured data sharing                             
    └── With permission checks  

3. EXTERNAL STORAGE                                        
    └── /sdcard/ - Any app can access                       
    └── With STORAGE permission    


4. INTENTS                                                 
    └── Message passing between apps 


 5. BOUND SERVICES                                          
    └── IPC between apps  


###  BYPASS METHODS:  SANDBOX PENTESTING  

**BYPASS METHODS:**   
 1. Root access                                              
    1. └── Full filesystem access  

 2. Debuggable app                                           
    1. └── adb run-as com.example.app

3. Backup extraction                                        
    1. └── If allowBackup="true"  

4. World-readable files                                     
    1. └── Developer mistake 

5. Content Provider vulnerabilities                         
    1. └── SQL injection, path traversal  

6. Shared UID                                               
    1. └── Install malicious app with same sharedUserId         
    2. └── (Requires same signing key)  


## 2. Permission Model

**Permission Architecture**
```
┌─────────────────────────────────────────────────────────────────┐
│                    ANDROID PERMISSION MODEL                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    PERMISSION LEVELS                        │ │
│  ├────────────────────────────────────────────────────────────┤ │
│  │                                                             │ │
│  │  NORMAL          ──► Auto-granted at install               │ │
│  │  (Low Risk)          No user interaction needed            │ │
│  │                                                             │ │
│  │  DANGEROUS       ──► User must explicitly grant            │ │
│  │  (Privacy/Data)      Runtime permission (API 23+)          │ │
│  │                                                             │ │
│  │  SIGNATURE       ──► Granted only if apps signed           │ │
│  │  (System)            with same certificate                 │ │
│  │                                                             │ │
│  │  SIGNATURE|      ──► Signature OR privileged app           │ │
│  │  PRIVILEGED          (in /system/priv-app/)                │ │
│  │                                                             │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

#### Runtime Permission Flow (API 23+)
```
┌─────────────────────────────────────────────────────────────────┐
│                RUNTIME PERMISSION FLOW                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│    ┌──────────────────┐                                         │
│    │ App Requests     │                                         │
│    │ Permission       │                                         │
│    └────────┬─────────┘                                         │
│             │                                                    │
│             ▼                                                    │
│    ┌──────────────────┐                                         │
│    │ Check if Already │──── YES ────► Permission Granted        │
│    │ Granted?         │                                         │
│    └────────┬─────────┘                                         │
│             │ NO                                                 │
│             ▼                                                    │
│    ┌──────────────────┐                                         │
│    │ Show Permission  │                                         │
│    │ Dialog to User   │                                         │
│    └────────┬─────────┘                                         │
│             │                                                    │
│       ┌─────┴─────┐                                             │
│       ▼           ▼                                             │
│    ALLOW       DENY                                              │
│       │           │                                             │
│       ▼           ▼                                             │
│   Permission   Permission                                        │
│   Granted      Denied                                            │
│                   │                                             │
│              ┌────┴────┐                                        │
│              ▼         ▼                                        │
│         "Don't Ask   Can Ask                                    │
│          Again"      Again                                      │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```



## 3. Application Signing

All apps must be digitally signed

Identifies the developer (not trust)

Prevents unauthorized updates

### APP SIGNING
```
┌────────────────────────────────────────────────────────────┐
│                     APP SIGNING EXPLAINED                   │
├────────────────────────────────────────────────────────────┤
│                                                             │
│  REAL WORLD ANALOGY:                                        │
│  ───────────────────                                        │
│                                                             │
│  Think of it like a NOTARIZED DOCUMENT:                     │
│                                                             │
│  ┌────────────────────────────────────────┐                │
│  │                                         │                │
│  │  Document: "This is my app v1.0"       │                │
│  │                                         │                │
│  │  Signed by: John Developer              │                │
│  │  Signature: [Unique cryptographic mark] │                │
│  │                                         │                │
│  │  ✓ Proves John wrote this               │                │
│  │  ✓ Proves document not modified         │                │
│  │  ✓ Only John can write updates          │                │
│  │                                         │                │
│  └────────────────────────────────────────┘                │
│                                                             │
│  WHAT SIGNING GUARANTEES:                                   │
│  ────────────────────────                                   │
│                                                             │
│  1. INTEGRITY                                               │
│     └── APK has not been modified after signing             │
│     └── Any tampering breaks the signature                  │
│                                                             │
│  2. AUTHENTICITY                                            │
│     └── Proves who created the app                          │
│     └── Developer's identity is verifiable                  │
│                                                             │
│  3. UPDATE AUTHORIZATION                                    │
│     └── Only apps signed with SAME key can update          │
│     └── Prevents malicious updates                          │
│                                                             │
│  4. TRUST ESTABLISHMENT                                     │
│     └── Same signature = Same developer = Shared trust     │
│     └── Enables signature-level permissions                 │
│                                                             │
└────────────────────────────────────────────────────────────┘
```


## 4. SELinux (Security-Enhanced Linux)

SELinux provides Mandatory Access Control (MAC) - an extra security layer on top of traditional Linux permissions.

```
┌────────────────────────────────────────────────────────────┐
│                                                            │
│   NORMAL SECURITY (Without SELinux)                        │
│   "You have the key? OK, come in!"                         │
│                                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│   WITH SELINUX                                             │
│   "You have key, but let me check                          │
│    the rulebook if you're allowed..."                      │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

#### DAC vs MAC

| Type                               | Description<br>                                                                                        |
| ---------------------------------- | ------------------------------------------------------------------------------------------------------ |
| DAC (Discretionary Access Control) | Traditional Linux permissions. Owner controls access. If compromised, attacker has user's permissions. |
| MAC (Mandatory Access Control)     | System-enforced policies. Even root restricted by policy. Defense in depth.                            |

#### SELinux Modes

Mode	Description

| Mode         | Description<br>                                                                                  |
| ------------ | ------------------------------------------------------------------------------------------------ |
| `Disabled`   | SELinux completely off. No MAC enforcement. NOT allowed on Android 5.0+                          |
| `Permissive` | Logs violations but doesn't block. Used for policy development. All access allowed, only logged. |
| `Enforcing`  | Actively enforces policies. Blocks unauthorized access. Logs violations. Required on Android.    |
**Check SELinux Status**
```
adb shell getenforce
# Output: Enforcing | Permissive | Disabled
```

#### SELinux Context Labels
Context Format
user:role:type:level

Example: u:r:untrusted_app:s0:c512,c768

**Component**	                            **Description**
u	                                                   User
r	                                                   Role
untrusted_app	                               Type (most important)
s0:c512,c768	                                MLS/MCS Level



## 5. Secure Boot Chain

#### Boot Process Overview
When the phone turns ON, it verifies each component step by step before loading the next.

```
┌──────────────────────────────────────────────────────────┐
│  STAGE 1: PRIMARY BOOTLOADER (PBL)                       │
│  ├── Burned into ROM (hardware)                          │
│  ├── Cannot be modified                                  │
│  ├── Contains Root of Trust (public key)                 │
│  └── Verifies Secondary Bootloader                       │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│  STAGE 2: SECONDARY BOOTLOADER (SBL/XBL)                 │
│  ├── Stored in boot partition                            │
│  ├── Initializes hardware                                │
│  ├── Loads and verifies Aboot/ABL                       │
│  └── May implement Fastboot                              │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│  STAGE 3: ANDROID BOOTLOADER (Aboot/ABL)                 │
│  ├── Implements Fastboot mode                            │
│  ├── Verifies boot/recovery partition                    │
│  ├── Checks device lock status                           │
│  └── Implements Android Verified Boot (AVB)              │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│  STAGE 4: KERNEL + RAMDISK                               │
│  ├── Linux kernel loads                                  │
│  ├── Initial ramdisk mounted                             │
│  ├── dm-verity verifies system partition                 │
│  └── Init process starts                                 │
└────────────────────────┬─────────────────────────────────┘
                         ▼
┌──────────────────────────────────────────────────────────┐
│  STAGE 5: ANDROID SYSTEM                                 │
│  ├── Init process executes                               │
│  ├── Zygote starts                                       │
│  ├── System Server starts                                │
│  └── Android framework boots                             │
└──────────────────────────────────────────────────────────┘
```