# Shared Preference

Shared Preferences is an Android API used to store small collections of primitive data (Booleans, floats, integers, longs, strings) in key-value pairs.

**The vulnerability exists when developers store sensitive information (PII, Passwords, API Tokens, Session IDs) in Shared Preferences without implementing encryption. If an attacker gains physical access to an unlocked device, uses a malicious app with root privileges, or dumps the filesystem, they can read this data in plain text.**

1. **Working:** The Android OS creates an ==XML== file in the app's private directory to store this data.
2. **Path:** These files are typically located at:
```
    /data/data/<package_name>/shared_prefs/<filename>.xml
```

**Vulnerability:** Developers often make the mistake of storing sensitive information (like passwords, API keys, or session tokens) in Shared Preferences in plain text (unencrypted). If an attacker gains access to the device (physically or via malware with root access), they can easily read these secrets.


## Beetle Bug APK Lab
##### Step 1: Input Data
Enter credentials:

    User: admin
    Pass: SuperSecret123


##### Step 2: Access Device Shell
Connect to the device using ADB from your host machine.

```Bash
adb shell
```

##### Step 3: Escalate Privileges
Switch to the root user to access the protected /data/ directory.

```BASH
su
# Prompt should change from $ to #
```

##### Step 4: Locate Application Package
Find the specific package name for Beetle Bug.

```BASH
pm list packages | grep beetle
# Output typically: com.beetlebug
```

##### Step 5: Navigate to Shared Prefs
Move to the application's data directory.

```BASH
cd /data/data/com.beetlebug/shared_prefs
ls -la
```
Look for .xml files (e.g., UserPrefs.xml or sp_info.xml).

##### Step 6: Extract Data
Read the content of the XML file.

```BASH
cat sp_info.xml
```

##### Result (Evidence)
```XML
<?xml version='1.0' encoding='utf-8' standalone='yes' ?>
<map>
    <string name="User">admin</string>
    <string name="Password">SuperSecret123</string>
</map>
```

## Prevention/Mitigation

1. **Avoid Storing Sensitive Data:** Do not store passwords or PINs locally if possible. Use session tokens instead.
2. **Use EncryptedSharedPreferences:** Instead of the standard SharedPreferences, use the Android Jetpack Security library.
    - It encrypts keys (using deterministic encryption).
    - It encrypts values (using AES-256 GCM).

# External Storage(SD Card)

In Android, file storage is divided into two main types:
1. **Internal Storage:** Private to the app. Other apps cannot access it (unless the device is rooted).
2. **External Storage:** Shared storage (e.g., /sdcard/). Historically, this space was used for photos, downloads, and documents.

 ##### **Vulnerability:**
 Files stored in External Storage are globally readable and globally writable by other applications that have the READ_EXTERNAL_STORAGE permission.
 
1. **The Risk:** If a legitimate banking app saves your statement to External Storage, a malicious "Flashlight" app installed on your phone can read that statement silently in the background and upload it to a hacker.
2. **Root requirement:** Unlike Lab 1 (Internal Storage), an attacker often does not need root access to exploit this. They just need a malicious app installed on the victim's phone.

**Attack:** A malicious app can scan the SD card for files containing "password", "config", or "token" and steal them or can send to an attacker.

##### Step 1: Input Data
Enter dummy credentials:

    User: sdcard_user
    Pass: public123

##### Step 2: Access Device Shell
```bash
adb shell
```

##### Step 3: Navigate to External Storage
```bash
cd /sdcard/
```

##### Step 4: Locate the File
List the files to find the one created by the app. It is often created in the root of the SD card or inside a folder named BeetleBug.

```bash
ls -la
```

Look for a file named Data.txt, info.txt, or a folder named BeetleBug.

If you see a folder, enter it:
```bash
cd BeetleBug  # (Example folder name)
ls
```

##### Step 5: Extract Data
Read the content of the file.

```
cat Data.txt
```

##### Result
```
Username: sdcard_user
Password: public123
```
The credentials are stored in plain text in a globally accessible directory.

## Prevention/Mitigation

1. Use Internal Storage: Always store sensitive data in the app's private directory (Context.getFilesDir()), which creates files in /data/data/<package>/.

2. Avoid External Storage for Secrets: Never place PII, tokens, or passwords on External Storage.

Scoped Storage (Android 10+): Even with modern Android "Scoped Storage" (which limits how apps see each other's files), sensitive data should still default to Internal Storage to ensure backward compatibility and maximum security.

Encryption: If business requirements force you to use External Storage, the file content must be encrypted using Jetpack Security or AES before writing to the disk.
